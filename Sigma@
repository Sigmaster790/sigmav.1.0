local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local flying = false
local speed = 100
local selectedPlayer = nil
local espEnabled = false
local hitboxEnabled = false
local espObjects = {}
local hitboxObjects = {}

-- Variable para Infinite Jump
local infiniteJumpEnabled = false

-- Variables para Aimbot
local aimbotEnabled = false
local aimbotSettings = {
    Enabled = false,
    TeamCheck = false,
    AliveCheck = true,
    WallCheck = false,
    Sensitivity = 0,
    TriggerKey = "MouseButton2",
    LockPart = "Head"
}

-- Variables para Infinite Jump y Noclip
local noclipEnabled = false
local noclipConnection = nil

local function createNewGui()
    -- Eliminar GUI existente si hay alguna
    local existingGui = player.PlayerGui:FindFirstChild("FlightGui")
    if existingGui then
        existingGui:Destroy()
    end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "FlightGui"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player.PlayerGui

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 400, 0, 500)
    mainFrame.Position = UDim2.new(0.5, -200, 0.5, -250)
    mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    -- Título
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, 30)
    titleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame

    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, 0, 1, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = "SigmaHub | v1.0"
    titleText.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleText.Font = Enum.Font.GothamBold
    titleText.TextSize = 14
    titleText.Parent = titleBar

    -- Pestañas
    local tabButtons = Instance.new("Frame")
    tabButtons.Size = UDim2.new(1, 0, 0, 30)
    tabButtons.Position = UDim2.new(0, 0, 0, 30)
    tabButtons.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    tabButtons.BorderSizePixel = 0
    tabButtons.Parent = mainFrame

    -- Contenedor principal
    local contentFrame = Instance.new("Frame")
    contentFrame.Size = UDim2.new(1, 0, 1, -60)
    contentFrame.Position = UDim2.new(0, 0, 0, 60)
    contentFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    contentFrame.BorderSizePixel = 0
    contentFrame.Parent = mainFrame

    -- Crear secciones
    local sections = {
        {
            name = "Movement",
            options = {
                {type = "slider", name = "walkSpeed", text = "WalkSpeed", min = 16, max = 100, default = 16},
                {type = "slider", name = "jumpPower", text = "JumpPower", min = 16, max = 100, default = 50},
                {type = "toggle", name = "infiniteJump", text = "Infinite Jump"},
                {type = "toggle", name = "noclip", text = "Noclip"},
                {type = "toggle", name = "flight", text = "Flight"}
            }
        },
        {
            name = "Combat",
            options = {
                {type = "toggle", name = "aimbot", text = "Aimbot"},
                {type = "toggle", name = "esp", text = "ESP"},
                {type = "toggle", name = "hitbox", text = "Hitbox"}
            }
        },
        {
            name = "Teleport",
            options = {
                {type = "dropdown", name = "playerSelect", text = "Select Player"},
                {type = "button", name = "teleport", text = "Teleport to Player"}
            }
        }
    }

    -- Crear pestañas
    local tabX = 10
    local selectedTab = nil
    local tabFrames = {}

    for _, section in ipairs(sections) do
        -- Botón de pestaña
        local tabButton = Instance.new("TextButton")
        tabButton.Size = UDim2.new(0, 80, 1, -4)
        tabButton.Position = UDim2.new(0, tabX, 0, 2)
        tabButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        tabButton.Text = section.name
        tabButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        tabButton.Font = Enum.Font.GothamSemibold
        tabButton.TextSize = 12
        tabButton.Parent = tabButtons
        
        -- Frame de contenido
        local sectionFrame = Instance.new("ScrollingFrame")
        sectionFrame.Size = UDim2.new(1, -20, 1, -10)
        sectionFrame.Position = UDim2.new(0, 10, 0, 5)
        sectionFrame.BackgroundTransparency = 1
        sectionFrame.ScrollBarThickness = 4
        sectionFrame.Visible = false
        sectionFrame.Parent = contentFrame
        tabFrames[section.name] = sectionFrame

        -- Crear opciones
        local yPos = 10
        for _, option in ipairs(section.options) do
            if option.type == "toggle" then
                local toggle = Instance.new("TextButton")
                toggle.Size = UDim2.new(1, -10, 0, 30)
                toggle.Position = UDim2.new(0, 5, 0, yPos)
                toggle.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
                toggle.Text = option.text
                toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
                toggle.Font = Enum.Font.GothamSemibold
                toggle.TextSize = 14
                toggle.Parent = sectionFrame

                -- Agregar funcionalidad para las opciones de Combat
                if option.name == "aimbot" then
                    toggle.MouseButton1Click:Connect(function()
                        local enabled = toggle.BackgroundColor3 == Color3.fromRGB(30, 30, 30)
                        toggle.BackgroundColor3 = enabled and Color3.fromRGB(100, 60, 180) or Color3.fromRGB(30, 30, 30)
                        
                        if enabled then
                            -- Activar Aimbot
                            loadstring(game:HttpGet("https://raw.githubusercontent.com/Exunys/Aimbot-V2/main/Resources/Scripts/Main.lua"))()
                            getgenv().Aimbot.Settings.Enabled = true
                        else
                            -- Desactivar Aimbot
                            pcall(function()
                                getgenv().Aimbot.Settings.Enabled = false
                                getgenv().Aimbot.Functions:Exit()
                            end)
                        end
                    end)
                elseif option.name == "esp" then
                    toggle.MouseButton1Click:Connect(function()
                        local enabled = toggle.BackgroundColor3 == Color3.fromRGB(30, 30, 30)
                        toggle.BackgroundColor3 = enabled and Color3.fromRGB(100, 60, 180) or Color3.fromRGB(30, 30, 30)
                        espEnabled = enabled
                        
                        if enabled then
                            -- Activar ESP
                            for _, p in ipairs(Players:GetPlayers()) do
                                if p ~= Players.LocalPlayer and p.Character then
                                    createESP(p)
                                end
                            end
                        else
                            -- Desactivar ESP
                            for _, esp in ipairs(espObjects) do
                                esp:Destroy()
                            end
                            espObjects = {}
                        end
                    end)
                elseif option.name == "hitbox" then
                    toggle.MouseButton1Click:Connect(function()
                        local enabled = toggle.BackgroundColor3 == Color3.fromRGB(30, 30, 30)
                        toggle.BackgroundColor3 = enabled and Color3.fromRGB(100, 60, 180) or Color3.fromRGB(30, 30, 30)
                        hitboxEnabled = enabled
                        
                        if enabled then
                            -- Activar Hitbox
                            for _, p in ipairs(Players:GetPlayers()) do
                                if p ~= Players.LocalPlayer and p.Character then
                                    createHitbox(p)
                                end
                            end
                        else
                            -- Desactivar Hitbox
                            for _, hitbox in ipairs(hitboxObjects) do
                                hitbox:Destroy()
                            end
                            hitboxObjects = {}
                        end
                    end)
                end
            elseif option.type == "slider" then
                local sliderFrame = Instance.new("Frame")
                sliderFrame.Size = UDim2.new(1, -10, 0, 50)
                sliderFrame.Position = UDim2.new(0, 5, 0, yPos)
                sliderFrame.BackgroundTransparency = 1
                sliderFrame.Parent = sectionFrame
            end
            yPos = yPos + 40
        end

        tabButton.MouseButton1Click:Connect(function()
            if selectedTab then
                tabFrames[selectedTab].Visible = false
            end
            selectedTab = section.name
            tabFrames[selectedTab].Visible = true
        end)

        tabX = tabX + 85
    end

    -- Mostrar primera pestaña por defecto
    selectedTab = sections[1].name
    tabFrames[selectedTab].Visible = true

    -- Hacer la interfaz arrastrable
    local dragging = false
    local dragStart = nil
    local startPos = nil

    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
        end
    end)

    titleBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)

    return mainFrame
end

local function startFlying()
    if flying then return end
    flying = true

    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.P = 9e4
    bodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bodyGyro.CFrame = humanoidRootPart.CFrame
    bodyGyro.Parent = humanoidRootPart

    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Velocity = Vector3.new(0, 0.1, 0)
    bodyVelocity.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bodyVelocity.Parent = humanoidRootPart

    while flying and humanoidRootPart and humanoidRootPart.Parent do
        humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
        local lookVector = workspace.CurrentCamera.CFrame.LookVector
        local move = Vector3.new(
            UserInputService:IsKeyDown(Enum.KeyCode.A) and -1 or (UserInputService:IsKeyDown(Enum.KeyCode.D) and 1 or 0),
            UserInputService:IsKeyDown(Enum.KeyCode.Space) and 1 or (UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and -1 or 0),
            UserInputService:IsKeyDown(Enum.KeyCode.W) and -1 or (UserInputService:IsKeyDown(Enum.KeyCode.S) and 1 or 0)
        )
        bodyVelocity.Velocity = (lookVector * -move.Z + workspace.CurrentCamera.CFrame.RightVector * move.X + Vector3.new(0, 1, 0) * move.Y) * speed
        bodyGyro.CFrame = workspace.CurrentCamera.CFrame
        RunService.Stepped:Wait()
    end

    if bodyGyro then bodyGyro:Destroy() end
    if bodyVelocity then bodyVelocity:Destroy() end
    if humanoid and humanoid.Parent then
        humanoid:ChangeState(Enum.HumanoidStateType.Landed)
    end
end

local function stopFlying()
    flying = false
    if humanoid and humanoid.Parent then
        humanoid:ChangeState(Enum.HumanoidStateType.Landed)
        -- Eliminar BodyGyro y BodyVelocity si existen
        for _, child in ipairs(humanoidRootPart:GetChildren()) do
            if child:IsA("BodyGyro") or child:IsA("BodyVelocity") then
                child:Destroy()
            end
        end
    end
end

local function updatePlayerList(playerListFrame, playerDropdown)
    for _, child in ipairs(playerListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= player then
            local playerButton = Instance.new("TextButton")
            playerButton.Size = UDim2.new(1, 0, 0, 30)
            playerButton.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
            playerButton.Text = p.Name
            playerButton.TextColor3 = Color3.new(1, 1, 1)
            playerButton.Font = Enum.Font.Gotham
            playerButton.TextSize = 14
            playerButton.Parent = playerListFrame

            playerButton.MouseButton1Click:Connect(function()
                selectedPlayer = p
                playerDropdown.Text = p.Name
                playerListFrame.Visible = false
            end)
        end
    end

    playerListFrame.CanvasSize = UDim2.new(0, 0, 0, #playerListFrame:GetChildren() * 30)
end

-- Función para crear ESP
local function createESP(player)
    if player == Players.LocalPlayer then return end
    
    local esp = Instance.new("BoxHandleAdornment")
    esp.Name = "ESP"
    esp.Size = Vector3.new(4, 5, 1)
    esp.Color3 = Color3.new(1, 0, 0)
    esp.Transparency = 0.5
    esp.AlwaysOnTop = true
    esp.ZIndex = 5
    esp.Adornee = player.Character:FindFirstChild("HumanoidRootPart")
    esp.Parent = player.Character:FindFirstChild("HumanoidRootPart")
    
    table.insert(espObjects, esp)
end

-- Función para crear Hitbox
local function createHitbox(player)
    if player == Players.LocalPlayer then return end
    
    local hitbox = Instance.new("SelectionBox")
    hitbox.Name = "Hitbox"
    hitbox.LineThickness = 0.02
    hitbox.Color3 = Color3.new(0, 1, 0)
    hitbox.Transparency = 0.5
    hitbox.Adornee = player.Character:FindFirstChild("HumanoidRootPart")
    hitbox.Parent = player.Character:FindFirstChild("HumanoidRootPart")
    
    table.insert(hitboxObjects, hitbox)
end

-- Función para actualizar ESP y Hitbox
local function updateVisuals()
    -- Limpiar visuales existentes
    for _, obj in ipairs(espObjects) do
        obj:Destroy()
    end
    for _, obj in ipairs(hitboxObjects) do
        obj:Destroy()
    end
    espObjects = {}
    hitboxObjects = {}
    
    -- Crear nuevos visuales
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            if espEnabled then
                createESP(p)
            end
            if hitboxEnabled then
                createHitbox(p)
            end
        end
    end
end

-- Función para manejar Infinite Jump
local function handleInfiniteJump()
    UserInputService.JumpRequest:Connect(function()
        if infiniteJumpEnabled and character and humanoid then
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end
    end)
end

local function initializeFlight()
    local gui = createNewGui()

    gui.flightButton.MouseButton1Click:Connect(function()
        if flying then
            stopFlying()
            gui.flightButton.Text = "Activar Vuelo"
            gui.flightButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        else
            startFlying()
            gui.flightButton.Text = "Desactivar Vuelo"
            gui.flightButton.BackgroundColor3 = Color3.fromRGB(215, 0, 0)
        end
    end)

    gui.disableButton.MouseButton1Click:Connect(function()
        stopFlying()
        gui.flightButton.Text = "Activar Vuelo"
        gui.flightButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    end)

    gui.teleportButton.MouseButton1Click:Connect(function()
        if selectedPlayer and selectedPlayer.Character then
            local targetHRP = selectedPlayer.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                humanoidRootPart.CFrame = targetHRP.CFrame
            end
        end
    end)

    gui.playerDropdown.MouseButton1Click:Connect(function()
        updatePlayerList(gui.playerListFrame, gui.playerDropdown)
        gui.playerListFrame.Visible = not gui.playerListFrame.Visible
    end)

    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.F then
            if flying then
                stopFlying()
                gui.flightButton.Text = "Activar Vuelo"
                gui.flightButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
            else
                startFlying()
                gui.flightButton.Text = "Desactivar Vuelo"
                gui.flightButton.BackgroundColor3 = Color3.fromRGB(215, 0, 0)
            end
        end
    end)

    player.CharacterAdded:Connect(function(newCharacter)
        character = newCharacter
        humanoid = character:WaitForChild("Humanoid")
        humanoidRootPart = character:WaitForChild("HumanoidRootPart")
        stopFlying()
        gui.flightButton.Text = "Activar Vuelo"
        gui.flightButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
        handleInfiniteJump()
    end)

    Players.PlayerAdded:Connect(function()
        updatePlayerList(gui.playerListFrame, gui.playerDropdown)
    end)

    Players.PlayerRemoving:Connect(function()
        updatePlayerList(gui.playerListFrame, gui.playerDropdown)
    end)

    updatePlayerList(gui.playerListFrame, gui.playerDropdown)

    -- ESP Button Handler
    gui.espButton.MouseButton1Click:Connect(function()
        espEnabled = not espEnabled
        gui.espButton.Text = "ESP: " .. (espEnabled and "Activado" or "Desactivado")
        gui.espButton.BackgroundColor3 = espEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(0, 120, 215)
        updateVisuals()
    end)

    -- Hitbox Button Handler
    gui.hitboxButton.MouseButton1Click:Connect(function()
        hitboxEnabled = not hitboxEnabled
        gui.hitboxButton.Text = "Hitbox: " .. (hitboxEnabled and "Activado" or "Desactivado")
        gui.hitboxButton.BackgroundColor3 = hitboxEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(0, 120, 215)
        updateVisuals()
    end)

    -- Infinite Jump
    gui.jumpButton.MouseButton1Click:Connect(function()
        infiniteJumpEnabled = not infiniteJumpEnabled
        gui.jumpButton.Text = "Infinite Jump: " .. (infiniteJumpEnabled and "ON" or "OFF")
        gui.jumpButton.BackgroundColor3 = infiniteJumpEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(0, 120, 215)
    end)

    -- Inicializar Infinite Jump
    handleInfiniteJump()

    -- Actualizar visuales cuando los jugadores entran/salen
    Players.PlayerAdded:Connect(function(player)
        player.CharacterAdded:Connect(function()
            wait(1) -- Esperar a que el personaje cargue completamente
            updateVisuals()
        end)
    end)

    Players.PlayerRemoving:Connect(updateVisuals)

    -- Actualización periódica de visuales
    RunService.Heartbeat:Connect(function()
        if espEnabled or hitboxEnabled then
            updateVisuals()
        end
    end)

    -- Aimbot
    gui.aimbotButton.MouseButton1Click:Connect(function()
        aimbotEnabled = not aimbotEnabled
        gui.aimbotButton.Text = "Aimbot: " .. (aimbotEnabled and "ON" or "OFF")
        gui.aimbotButton.BackgroundColor3 = aimbotEnabled and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(0, 120, 215)
        
        if aimbotEnabled then
            -- Cargar el script de Aimbot
            loadstring(game:HttpGet("https://raw.githubusercontent.com/Exunys/Aimbot-V2/main/Resources/Scripts/Main.lua"))()
            getgenv().Aimbot.Settings.Enabled = true
        else
            -- Desactivar Aimbot
            pcall(function()
                getgenv().Aimbot.Settings.Enabled = false
                getgenv().Aimbot.Functions:Exit()
            end)
        end
    end)
end

initializeFlight()
